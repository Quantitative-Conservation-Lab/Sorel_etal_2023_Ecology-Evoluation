These are modified functions from BTSPAS, with fixes recomended by THomas Buehrens
